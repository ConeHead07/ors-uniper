{if false}admin_umzugsformular_leistungsauswahl.tpl.html<br>{/if}
{assign var="colspan" value=3}

{if !isset($mengeReklasReadOnly)}
{assign var="mengeReklasReadOnly" value=1}
{/if}

{if !isset($showAID)}
{assign var="showAID" value=0}
{/if}

{if $PreiseAnzeigen}
{assign var="colspan" value=$colspan+2}
{/if}

{if !empty($enableLeistungCheckbox)}
{assign var="colspan" value=$colspan+1}
{/if}

{if !empty($addReklas)}
{assign var="colspan" value=$colspan+1}
{/if}
{if !empty($showReklas)}
{assign var="colspan" value=$colspan+1}
{/if}

{if !empty($addTeilmengen)}
{assign var="colspan" value=$colspan+1}
{/if}

{if !empty($showLiefermenge)}
{assign var="colspan" value=$colspan+1}
{/if}

{if !empty($showAID)}
{assign var="colspan" value=$colspan+1}
{/if}

{if !isset($showAddLeistung)}
{assign var="showAddLeistung" value=0}
{/if}

{if !isset($showDropLeistung)}
{assign var="showDropLeistung" value=0}
{/if}

{assign var="Gesamtsumme" value="0"}

{assign var="uniqueId" value=uniqid()}

{literal}
<style>
    .table-leistungen .col.menge,
    .table-leistungen .col.field-menge_mertens,
    .table-leistungen .col.field-menge_rekla,
    .table-leistungen .col.field-menge_geliefert,
    .table-leistungen .col.field-add_rekla {
        max-width:7vh;
    }
    .table-leistungen thead th {
        font-size: 0.75rem;
    }
    .table-leistungen .row-checkbox,
    .table-leistungen .col.menge {
        vertical-align: middle;
    }
    .table-leistungen.MitarbeierItem .row.inputRowVon input {
        height:1.2em;
    }
    .table-leistungen td.with-input {
        padding:0;
    }
</style>
{/literal}
<div class="widget-leistungsauswahl" id="widgetLA_{$uniqueId}" data-src="admin/umzugsformular/leistungsauswahl/tpl/html" data-test="2" style="display:block;margin-top:15px;">
    <!-- admin_umzugsformular_leistungsauswahl.tpl.html -->
    {if $showAddLeistung}
    <div>
    <span style="margin-bottom:2px;color:#549e1a;font-weight:bold;text-decoration:none;cursor:pointer;"
          class="btn-add-leistung" data-test="3">
    Leistung hinzuf&uuml;gen <img align="absmiddle" src="images/hinzufuegen_off.png" width="14" alt=""></span>
    </div>
    {/if}
    <h2 style="margin:0">{if empty($title)}Bestellte Leistungen{else}{$title}{/if}</h2>
    <table class="table-leistungen MitarbeierItem" style="width:100%;">
        <thead>
            <tr>
                {if $showDropLeistung}
                <th class="drop-leistung" style="width:14px;padding:0;"> X </th>
                {/if}

                {if isset($enableLeistungCheckbox) && !empty($enableLeistungCheckbox)}
                <th class="leistung-checkbox" style="width:14px;padding:0;"> [-] </th>
                {/if}

                {if !empty($showAID)}
                <th class="col field-aid">AID</th>
                {/if}

                <th class="col field-kategorie">Kategorie</th>
                <th class="col field-leistung">Leistung</th>
                <th class="col field-menge_mertens menge">B-Menge</th>

                {if !empty($showReklas)}
                <th class="col field-menge_rekla menge">R-Menge</th>
                {/if}

                {if !empty($addReklas)}
                <th class="col field-add_rekla menge" style="background-color:red;color:#fff;">Neue Reklas</th>
                {/if}

                {if !empty($showLiefermenge)}
                <th class="col field-menge_geliefert menge">Gelief</th>
                {/if}

                {if !empty($addTeilmengen)}
                <th class="col field-add_teil menge" style="background-color:darkgreen;color:#fff;">T-Menge</th>
                {/if}

                {if $PreiseAnzeigen}
                <th class="col col-preis preis">Preis</th>
                <th class="col field-sum sum">Gesamt</th>
                {/if}
            </tr>
        </thead>
        <tbody id="TblLeistungenBody">
        {foreach name=LList item=L from=$Umzugsleistungen}
            <tr class="row inputRowVon" data-lid="{$L.leistung_id}" data-row="{$L|json_encode|escape}">

                {if $showDropLeistung}
                <td class="drop-leistung" style="padding:0;"><span style="cursor:pointer;margin:0;padding:0;"><img style="cursor:pointer;margin:0;padding:0;" align="absmiddle" src="images/loeschen_off.png" width="14" alt=""></span></td>
                {/if}

                {if isset($enableLeistungCheckbox) && !empty($enableLeistungCheckbox)}
                <td class="row-checkbox">EX:{$enableLeistungCheckbox}
                    <input type="checkbox" name="chckLeistung[]" value="{$L.leistung_id}">
                </td>
                {/if}

                {if !empty($showAID)}
                <td class="col field-aid aid">
                    <a href="?s=aantrag&id={$L.aid|escape}" style="width:100%">{$L.aid|escape}</a>
                </td>
                {/if}

                <td class="col field-kategorie ktg1">{$L.kategorie|escape}</td>
                <td class="col field-leistung lstg" data-p="{$L.preis_pro_einheit}" data-sum="{$L.gesamtpreis}">
                    {if !empty($L.image)}
                    <div class="bild">
                        <img src="images/leistungskatalog/{$L.image}" style="float:left;max-width:120px;max-height:120px;border:0;margin-right:1rem;margin-bottom:.5rem;">
                    </div>
                    {/if}
                    <div class="Bezeichnung">{$L.leistung|escape}</div>
                    {if !empty($L.Beschreibung)}
                    <div class="Beschreibung">{$L.Beschreibung}</div>
                    {/if}
                    {if !empty($L.Farbe) || !empty($L.Groesse)}
                    <div class="produkt_varianten">
                        {if !empty($L.Farbe)}{$L.Farbe|escape}{/if}
                        {if !empty($L.Groesse)}{if !empty($L.Farbe)}, {/if}{$L.Groesse|escape}{/if}
                    </div>
                    {/if}
                    {if !empty($L.produkt_link)}
                    <div class="produkt_link">
                        <a href="{$L.produkt_link}" target="_PL{$L.leistung_id}">mehr Infos</a>
                    </div>
                    {/if}
                </td>

                <td class="col field-mertens_menge menge{if empty($mengeMertensReadOnly)} with-input{/if}">{if !empty($mengeMertensReadOnly)}
                    {$L.menge_mertens|number_format:2:",":"."}{else}
                    <input class="menge creator auftragsmenge" name="L[menge_mertens][]" value="{$L.menge_mertens}" type="number">
                    <input class="menge2 creator" name="L[menge2_mertens][]" value="{$L.menge2_mertens|number_format:2:',':'.'}" type="hidden"><input class="ilstg" name="L[leistung_id][]" value="{$L.leistung_id}" type="hidden">
                {/if}</td>

                {if !empty($showReklas)}
                <td class="col field-menge_rekla menge{if empty($mengeReklasReadOnly)} with-input{/if}">{if !empty($mengeReklasReadOnly)}
                    {$L.menge_rekla|number_format:2:",":"."}{else}
                    <input class="menge" name="L[menge_rekla][{$L.leistung_id}]" value="{$L.menge_rekla|number_format:2:',':'.'}" type="number">
                {/if}
                </td>
                {/if}

                {if !empty($addReklas)}
                <td class="col field-add_rekla menge"><input style="color:red" class="menge" name="L[neue_rekla][{$L.leistung_id}]" value="0" type="number" step="1" min="0" max="{$L.menge_mertens}"></td>
                {/if}

                {if !empty($showLiefermenge)}
                <td class="col field-menge_geliefert menge{if empty($mengeGeliefertReadOnly)} with-input{/if}">{if !empty($mengeGeliefertReadOnly)}
                    {$L.menge_geliefert|number_format:2:",":"."}{else}
                    <input class="menge" name="L[menge_geliefert][{$L.leistung_id}]" value="{$L.menge_geliefert|number_format:2:',':'.'}" type="text">
                    {/if}</td>
                {/if}

                {if !empty($addTeilmengen)}
                <td class="col field-add_teil menge"><input style="color:darkgreen" class="menge" name="L[neue_teilmenge][{$L.leistung_id}]" value="0" type="number" step="1" min="0" max="{$L.menge_mertens}"></td>
                {/if}

                {if $PreiseAnzeigen}
                <td class="preis">{if $L.preis_pro_einheit}{$L.preis_pro_einheit|number_format:2:",":"."} €{/if}</td>
                <td class="sum">{if is_numeric($L.gesamtpreis)}{$L.gesamtpreis|number_format:2:",":"."} €{/if}</td>
                {assign var="Gesamtsumme" value=$Gesamtsumme + $L.gesamtpreis}
                {/if}
            </tr>
        {/foreach}
            <tr id="summary">
                {if $PreiseAnzeigen}
                <td colspan="{$colspan}"><span id="allsum" data-allsum="0">{$Gesamtsumme|escape|number_format:2:",":"."}</span><span style="margin-left:5px">&euro;</span></td>
                {else}
                <td colspan="{$colspan}" style="display:none;"></td>
                {/if}
            </tr>
        </tbody>
    </table>

    <table id="TplLeistungTable" class="tpl-leistungen tpl-leistungen-{$uniqueId}" style="display:none;">
        <tr class="row inputRowVon">
            {if $showDropLeistung}
            <td class="drop-leistung" style="padding:0;"><span style="cursor:pointer;margin:0;padding:0;"><img style="cursor:pointer;margin:0;padding:0;" align="absmiddle" src="images/loeschen_off.png" width="14" alt=""/></span></td>
            {/if}

            {if isset($enableLeistungCheckbox) && !empty($enableLeistungCheckbox)}
            <td class="leistung-checkbox" class="row-checkbox">EC:{$enableLeistungCheckbox}
                <input type="checkbox" name="chckLeistung[]" value="{$L.leistung_id}">
            </td>
            {/if}

            {if !empty($showAID)}
            <td class="col field-aid aid">
                <a href="?s=aantrag&id={$L.aid|escape}" style="width:100%">{$L.aid|escape}</a>
            </td>
            {/if}

            <td class="col field-kategorie ktg1"></td>
            <td class="col field-leistung lstg" data-p="" data-sum=""></td>

            <td class="col field-mertens_menge menge{if empty($mengeMertensReadOnly)} with-input{/if}">
                <input class="menge creator" name="L[menge_mertens][]" value="1" min="0" type="number">
                <input class="menge2 creator" name="L[menge2_mertens][]" value="1" type="hidden">
                <input class="ilstg" name="L[leistung_id][]" value="" type="hidden"></td>

            {if !empty($showReklas)}
            <td class="col field-menge_rekla menge{if empty($mengeReklasReadOnly)} with-input{/if}">
                <input class="menge" name="L[menge_rekla][{$L.leistung_id}]" value="0" type="number">
            </td>
            {/if}

            {if !empty($addReklas)}
            <td class="col field-add_rekla menge"></td>
            {/if}

            {if !empty($showLiefermenge)}
            <td class="col field-menge_geliefert menge{if empty($mengeGeliefertReadOnly)} with-input{/if}"></td>
            {/if}

            {if !empty($addTeilmengen)}
            <td class="col field-add_teil menge"></td>
            {/if}

            {if $PreiseAnzeigen}
            <td class="col field-preis_pro_einheit preis">0 €</td>
            <td class="col field-gesamtpreis sum">0 € </td>
            {/if}
        </tr>
    </table>
    <input type="hidden" name="AS[leistungen_csv]" value="">
</div>

<script>
    $(function(){
        var lkItems = {$lkTreeItemsJson};
        var lkmById = {$lkmByIdJson};
        var widgetId = "widgetLA_{$uniqueId}";
        var widget = $("#" + widgetId);
        var lktgselectId = "widgetLA_{$uniqueId}_lktgselect";
        var ldescselectId = "widgetLA_{$uniqueId}_ldescselect";
        var tplLeistungenClass = "tpl-leistungen-{$uniqueId}";

        {literal}
        var lktgselect = $("<select/>" )
            .css({width:"500px",position:"absolute", zIndex:99, minWidth:250})
            .attr({id: lktgselectId, size:5})
            .hide()
            .appendTo("body");

        var ldescselect = $("<select/>" )
            .css({width:"500px",position:"absolute", zIndex:100, minWidth:280})
            .attr({id: ldescselectId, size:5})
            .hide()
            .appendTo( "body");

        var blurBox = function(callback, hide) {
            var blurBoxId = "BlurBox1";
            var body = $("body");

            if ( !$("#"+blurBoxId).length ) {
                body.append( $("<div/>").attr({id:blurBoxId}).css({position:"fixed",top:0,left:0,zIndex:98,display:"none"}) );
            }

            if (arguments.length > 1 && hide) {
                var bb = $("#" + blurBoxId).hide();
                return bb;
            }

            $("#" + blurBoxId)
                .css({width:"100%",minWidth:body.width(),height:"100%",minHeight:body.height()})
                .show()
                .click(function(e){
                    $( this ).hide();
                    if (typeof(callback) === "function") {
                        callback.call();
                    }
                    else {
                        if (callback) $( callback ).hide();
                    }
                });
        }

        var get_Kategorie = function() {
            obj = this;

            lktgselect
                .html(
                    $("<option/>").text("Bitte auswählen")
                );

            for(var ktg1 in lkItems) {
                var lNames = Object.keys(lkItems[ktg1]);
                var firstName = lNames[0];
                var lArt = lkItems[ktg1][firstName].leistungsart;

                lktgselect.append(
                    $("<option/>")
                        .val(ktg1)
                        .text(ktg1)
                        .data("leistungen", lkItems[ktg1])
                        .data("kategorie1", ktg1)
                        .data("leistungsart", lArt)
                );
            }

            lktgselect
                .unbind("change")
                .change(function(e) {
                    var lArt = $(this).find("option:selected").data("leistungsart");
                    $( obj ).data( "leistungsart", + lArt );

                    $( obj ).data(
                        "kategorie1",
                        $(this).find("option:selected").data("kategorie1")
                    );

                    $( obj ).data(
                        "leistungen",
                        $.extend({}, $(this).find("option:selected").data("leistungen"))
                    );

                    $( this ).hide();

                    get_Leistung.apply( $( obj ).closest("tr").find(".lstg").val("") );
                })
                .bind("blur", function(event){
                    $( this ).hide();
                })
                .css({
                    top: $(obj).offset().top + $(obj).height(),
                    left: $(obj).offset().left
                })
                .show();

            console.log("#140");
            blurBox( "#" + lktgselectId );
        }

        function lstgIsAllreadyInList(id, obj) {
            var widget = $( obj ).closest(".widget-leistungsauswahl");
            console.log("#148");
            var re = 0;
            widget.find("input.ilstg").not(obj).each(function(i){
                if ($(this).val() == id) re = 1;
            });
            return re;
        }

        function get_Leistung( obj ) {
            obj = this;
            console.log("#157");
            var objKtg1 = $( obj ).closest("tr").find(".ktg1");
            var objUnit = $( obj ).closest("tr").find(".unit:eq(0)");
            var objUnit2 = $( obj ).closest("tr").find(".unit:eq(1)");
            var objInpAll = $( obj ).closest("tr").find("input");
            var objInp = $( obj ).closest("tr").find("input.ilstg");
            var objInpM = $( obj ).closest("tr").find("input.menge:not([readonly]):not(.menge2)");
            var objInpM2 = $( obj ).closest("tr").find("input.menge2.creator");
            var objPreis = $( obj ).closest("tr").find("td.preis");
            var objSum = $( obj ).closest("tr").find("td.sum");
            if ( !$( objKtg1 ).data("kategorie1") ||  !$( objKtg1 ).data("leistungen") ) {
                get_Kategorie.apply( objKtg1 );
                return;
            };

            var leistungen = $( objKtg1 ).data( "leistungen" );
            var leistungsart = $( objKtg1 ).data( "leistungsart" );

            console.log("#174");
            ldescselect.data("leistungen", leistungen).html(
                $("<option/>").text("Bitte auswählen")
            );

            console.log("#179");
            for(var lstg in leistungen) {
                var lprops = leistungen[lstg];
                var optTxt = lprops.Bezeichnung;
                if ("Farbe" in lprops && typeof lprops.Farbe === 'string' && lprops.Farbe.length > 0) {
                    optTxt += ', ' + lprops.Farbe;
                }
                if ("Groesse" in lprops && typeof lprops.Groesse === 'string' && lprops.Groesse.length > 0) {
                    optTxt += ', ' + lprops.Groesse;
                }
                console.log('ldescselect option ', { lstg, lprops, optTxt });
                ldescselect.append(
                    $("<option/>")
                        .val(lstg)
                        .text(lstg)
                        .data("leistung", lprops)
                );
            }

            console.log("#190");
            ldescselect
                .unbind("change")
                .change(function(event){
                    var data = $(this)
                        .find("option:selected")
                        .data("leistung");
                    var oldMenge = (objInpM.length && objInpM.val()) ? +objInpM.val() : 0;
                    var newMenge = oldMenge > 0 ? oldMenge : 1;

                    console.log("#197");
                    if ( lstgIsAllreadyInList(data.leistung_id, objInp) ) {
                        console.log("Die Leistung wurde bereits in die Liste aufgenommen!\n" +
                            "Bitte fügen Sie die Mengen dem bestehenden Eintrag hinzu.\n"+
                            "Andernfalls werden bestehende Mengen überschrieben."
                        );
                        objInp.blur();
                        return false;
                    }

                    console.log("#208");
                    $( objKtg1 )
                        .html( $( objKtg1)
                            .data( "kategorie1") );

                    $( obj )
                        .html( data.leistung )
                        .attr({"data-p": data.preis_pro_einheit, "data-sum":0});

                    objInpAll.val("");
                    $( objInp ).val( data.leistung_id );
                    $( objUnit ).html( data.leistungseinheit );
                    $( objUnit2 ).html( data.leistungseinheit2 );
                    objPreis.html( numberFormat(data.preis_pro_einheit, 2, ",") );
                    objSum.html("");

                    if (data.leistungseinheit2) {
                        objInpM2.val("1");
                        objInpM2.removeAttr("readonly");
                        objInpM2.unbind("change").bind("change", mengeChangeCallback);
                    } else {
                        objInpM2.val("");
                        objInpM2.attr("readonly", "readonly");
                        objInpM2.unbind("change");
                    }

                    objInpM.unbind("change");

                    if (!objUnit.html() || objUnit.html().toLowerCase().indexOf("prozent") < 0) {
                        objInpM.bind("change", mengeChangeCallback);
                    }

                    $( this ).hide();
                    blurBox( "#" + ldescselectId, 1);

                    if ( objInpM.length) {
                        console.log("#255");
                        objInpM.val(newMenge).get(0).focus();
                        objInpM.trigger("change");

                    }

                })
                .bind("blur", function(event){
                    $( this ).hide();
                })
                .css({
                    top: $(obj).offset().top + $(obj).height(),
                    left: $(obj).offset().left
                })
                .show();
            console.log("#269");
            blurBox( "#" + ldescselectId );
            console.log("#258");
        }

        function calc_AllSum() {
            widget.find("#TblLeistungenBody").each(function(){
                var allsum = 0;
                $(this).find("td.lstg").each(function(){
                    allsum+= parseFloat($(this).attr("data-sum"));
                });
                $(this).find("#allsum").attr("data-allsum",allsum).text(numberFormat(allsum,2, ",", "."));
            });
        }

        var numberFormat = function(number, dec, decToken, thousandSep) {
            console.log("#272");
            var n = parseFloat(number).toFixed(dec).split(".");
            if (n[0].length > 3 && thousandSep) {
                var nr = n[0];
                var nnr= "";
                for(var i = 0; i < nr.length; ++i) {
                    nnr+= nr.charAt(i);
                    if (nr.length-(i+1) > 0 && (nr.length-(i+1)) % 3 === 0) nnr+=".";
                }
                n[0] = nnr;
            }
            return n.join(decToken);
        }

        var mengeChangeCallback = function() {
            console.log("#287");
            var tr = $( this ).closest("tr");
            var objUnit = tr.find(".unit:eq(0)");
            if (objUnit.html() && objUnit.html().toLowerCase().indexOf("prozent") > -1) {
                return;
            }

            var id = tr.find("input.ilstg").val();
            var preis = parseFloat(tr.find("td.lstg").attr("data-p"));
            var val  = parseFloat(tr.find("input.menge.creator").val().replace(',', '.'));
            var val2 = parseFloat(tr.find("input.menge2.creator").val().replace(',', '.')) || 1;
            var mx = lkmById[ id ] || [];
            for(var i = 0; i < mx.length; ++i) {
                if ((1*mx[i].von) <= val && ( (1*mx[i].bis) < 0.01 || (1*mx[i].bis) >= val) ) {
                    preis = mx[i].preis;
                    tr.find("td.preis").html( numberFormat(preis, 2, ",", ".") );
                    break;
                }
            }
            tr.find("td.lstg").attr("data-sum", preis * val * val2);
            tr.find("td.sum").html( numberFormat(preis * val * val2, 2, ",", ".") );
            calc_AllSum();
            return false;
        };

        function drop_Leistung(obj) {
            if (typeof obj === 'undefined') {
                obj = this;
            }
            $( obj ).closest( "tr" ).remove();
            leistungenRowsChanged = true;
            calc_AllSum();
            callbackLeistungenChanged();
        }

        $(function(){
            $( "input.menge.creator, input.menge2.creator" ).bind("change", mengeChangeCallback);

            $("input[type=number][max]").bind('change', function(e) {
                var val = $(this).val();
                var maxVal = $(this).attr("max");
                var minVal = $(this).attr("min");

                if (isNaN(val)) {
                    $(this).val(0);
                    return;
                }

                if (maxVal !== undefined && !isNaN(maxVal)) {
                    if (parseFloat(val) > parseFloat(maxVal)) {
                        $(this).val(maxVal);
                        return;
                    }
                }

                if (minVal !== undefined && !isNaN(minVal)) {
                    if (parseFloat(val) < parseFloat(minVal)) {
                        $(this).val(minVal);
                        return;
                    }
                }

            });
        });

        function add_Leistung(e) {
            var selTblBody = "#TblLeistungenBody";
            var selTplRow = ".tpl-leistungen." + tplLeistungenClass + " .row";

            console.log("#597 executing add_Leistung", {
                widget,
                selTblBody,
                selTplRow,
                "widget.length": widget.length,
                "widget.TblLeistungenBody length": widget.find(selTblBody).length,
                "selTplRow length": $(selTplRow).length,
                e
            });
            if (!widget.find(selTblBody).length ) return false;
            if (!$(selTplRow).length) return false;

            var l = $(selTplRow).clone(true);
            l.find("input:disabled").each(function(){
                this.disabled = false;
            }); //.prop("disabled", false);

            var lastSumRowSel = "#TblLeistungenBody tr#summary";
            var lastSumRow = widget.find(lastSumRowSel);
            if (lastSumRow.length) {
                lastSumRow.before(l);

                l.find(".col.ktg1").unbind("click").bind("click", get_Kategorie.bind(l.find(".col.ktg1").get(0) ) );
                l.find(".col.lstg").unbind("click").bind("click", get_Leistung.bind(l.find(".col.lstg").get(0) ));
                l.find(".drop-leistung span").unbind("click").bind("click", drop_Leistung.bind(l.find(".drop-leistung span").get(0) ));

                l.find("td input").unbind("change").bind("change", callbackLeistungenChanged);
                $(".ktg1", l).trigger("click");
            } else {
                alert("lastSumRow not! found widget.find(" + lastSumRowSel + ")");
            }
            console.log("#345");
        }

        var leistungenOnLoad = {};
        var leistungenChangedFromP = true;
        var leistungenChanged = true;
        var leistungenRowsChanged = false;

        var callbackLeistungenChanged = function() {
            var b = widget.find("#btnStatGenJa");
            if (!b.attr("data-reCheckLabel")) return;
            b.val( getLeistungenChanged() ? b.attr("data-reCheckLabel") : b.attr("data-sendLabel") );
        };

        var getLeistungenChanged = function() {
            var changed = false;
            var leistungen = getLeistungenFormData();
            console.log("leistungen", leistungen);
            console.log("leistungenOnLoad", leistungenOnLoad);

            for(var j in leistungenOnLoad) {
                if (!(j in leistungen)) return true;
            }

            for(var i in leistungen) {
                if (!(i in leistungenOnLoad) && (leistungen[i].pm1 > 0 || leistungen[i].pm2 > 0)) {
                    return true;
                }
            }

            $.each(leistungen, function(i, val){
                if (
                    parseFloat(val.pm1.replace(',','.')).toFixed(2) != parseFloat(val.mm1.replace(',','.')).toFixed(2)
                    || parseFloat(val.pm2.replace(',','.')).toFixed(2) != parseFloat(val.mm2.replace(',','.')).toFixed(2) ) {
                    changed = true;
                }
            });
            return changed;
        };

        var getLeistungenFormData = function() {
        var leistungen = {};
        widget.find("#TblLeistungenBody tr").each(function(){
            if ($("td input", this).length < 4) return;
            var ilstg = $("input.ilstg", this).val();
            leistungen[ilstg] = {
                'pm1': $("td:eq(3) input.menge", this).val(),
                'pm2': $("td:eq(5) input.menge", this).val(),
                'mm1': $("td:eq(7) input.menge", this).val(),
                'mm2': $("td:eq(8) input.menge", this).val()
            };
        });
        return leistungen;
    };

        leistungenOnLoad = getLeistungenFormData();
        widget.find("#TblLeistungenBody tr input").change( callbackLeistungenChanged).eq(0).trigger("change");

        widget.find(".btn-add-leistung").unbind("click").bind("click", add_Leistung);
        widget.find(".col.ktg1").bind("click", get_Kategorie);
        widget.find(".col.lstg").bind("click", get_Leistung);
        widget.find(".drop-leistung span").bind("click", get_Leistung);
    });
    {/literal}
</script>
