<link rel="STYLESHEET" type="text/css" href="../css/SelBox.easy.css">
<link rel="STYLESHEET" type="text/css" href="css/SelBox.easy.css">

<div id="SysInfoBox"></div>

<link rel="stylesheet" type="text/css" href="css/umzugsformular.css">
<link rel="stylesheet" type="text/css" href="../css/umzugsformular.css">
<!-- MODUL UEBERSCHRIFTENBOX 109099 BEGIN --> 
<div class="divModuleBasic padding6px width5Col heightAuto colorContentMain"> 
<h1><span class="spanTitle">Leistungsanforderung #{$AS.aid}</span></h1> 
<p>
<div id="Umzugsantrag" class="divInlay"> 
  <h2 style="margin:0;">Auftrags-Status</h2>
  <table border=0 cellspacing=1 cellpadding=1>
    <tr>
      <td style="padding:0;height:auto;width:200px;"><label style="display:block;width:auto;">Ausf&uuml;hrungstermin:</label></td>
      <td style="padding:0;width:250px;">{$AS.umzugstermin|escape|date_format:"%d.%m.%Y"}</td>
    </tr>
    <tr>
      <td style="padding:0;height:auto;"><label style="display:block;width:auto;">Ausf&uuml;hrungszeit:</label></td>
      <td style="padding:0;">{$AS.umzugszeit|escape}</td>
    </tr>

    <tr>
      <td style="padding:0;height:auto;"><label style="display:block;width:auto;">Antragsdatum:</label></td>
      <td style="padding:0;">{$AS.antragsdatum|escape|date_format:"%d.%m.%Y"}</td>
    </tr>

    <tr>
      <td style="padding:0;"><label style="display:block;width:auto;">Bestätigt:</label></td>
      <td style="padding:0;" class="status_{$AS.genehmigt_br}"><img id="imgStatGen" src="images/status_{$AS.genehmigt_br|lower}.png"><span id="txtStatGen">{if $AS.genehmigt_br ne "Init"} {$AS.genehmigt_br} am {$AS.genehmigt_br_am|date_format:"%d.%m.%Y %H:%M"} {$AS.genehmigt_br_von}{/if}</span></td>
    </tr>

    <tr>
      <td style="padding:0;"><label style="display:block;width:auto;">Abgeschlossen:</label></td>
      <td style="padding:0;" class="status_{$AS.abgeschlossen}"><img id="imgStatAbg" src="images/status_{$AS.abgeschlossen|lower}.png"><span id="txtStatAbg">{if $AS.abgeschlossen ne "Init"} {$AS.abgeschlossen} am {$AS.abgeschlossen_am|date_format:"%d.%m.%Y %H:%M"} {$AS.abgeschlossen_von}{/if}</span></td>
    </tr>
    <tr>
      <td style="padding:0;"><label style="display:block;width:auto;">Status:</label></td>
      <td style="padding:0;">{if empty($AS.angeboten_am) and $AS.umzugsstatus|escape eq "genehmigt"}bestaetigt{else}{$AS.umzugsstatus|escape}{/if}</td>
    </tr>
      <!-- SelBox_initLSDefault(initInputObj, initLSName, initMultiple, initLSSearchFields, initLSInputFields) -->
  </table>
  <a href="%WebRoot%sites/umzugsblatt.php?id={$AS.aid}" style="display: none" target="_Umzugsblatt{$AS.aid}"><img src="%WebRoot%images/printer.png" width="16" height="16" alt="">Anforderungsblatt / Druckansicht</a>
    <a href="%WebRoot%sites/lieferschein.php?id={$AS.aid}" target="_Lieferschein{$AS.aid}"><img src="%WebRoot%images/printer.png" width="16" height="16" alt="">Lieferschein (PDF)</a>
  <br>

  <div style="float:left">
      <h2 style="margin:0;">Leistungsantragsteller</h2>
      <table>
        <tr>
          <td style="padding:0;width:200px;"><label style="display:block;width:auto;">Vor &amp; Nachname:</label></td>
          <td style="padding:0;width:250px;"><span data-fld="AS[vorname]">{$AS.vorname|escape}</span> <span data-fld="AS[name]">{$AS.name|escape}</span></td>
        </tr>
        <tr>
          <td style="padding:0;"><label style="display:block;width:auto;">E-Mail:</label></td>
          <td style="padding:0;" data-fld="AS[email]">{$AS.email|escape}</td>
        </tr>
        <tr>
          <td style="padding:0;"><label style="display:block;width:auto;">Fon:</label></td>
          <td style="padding:0;" data-fld="AS[fon]">{$AS.fon|escape}</td>
        </tr>
          <!-- SelBox_initLSDefault(initInputObj, initLSName, initMultiple, initLSSearchFields, initLSInputFields) -->
      </table>
      <br>
  </div>
  {if 1}
  <div style="float:left; margin-left:50px;">
      {include file="umzugsteam_umzugsformular_lieferauswahl.tpl.html"}
  </div>
  {/if}

  <br clear= "all">
  <div style="clear:both;"></div>


  {if 0}
      {include file="admin_umzugsformular_mitarbeiterauswahl.tpl.html"}
  {/if}
  {if 0}
      {include file="admin_umzugsformular_geraeteauswahl.tpl.html"}
  {/if}
  {if 0}
      {include file="admin_umzugsformular_ortsauswahl.tpl.html"}
  {/if}
  {if 1}
      {include file="umzugsformular_leistungsauswahl.tpl.read.html"}
  {/if}
  {if !empty($UmzugsAnlagen)}
    {include file="umzugsformular_attachments.tpl.read.html" internal=1}
  {/if}
  <br>
  {if !empty($UmzugsAnlagenIntern)}
    {include file="umzugsformular_attachments.tpl.read2.html" UmzugsAnlagen=$UmzugsAnlagenIntern internal=1}
  {/if}

  {if 0}
  <div style="width:100%">
      {include file="admin_umzugsformular_gruppierung.tpl.html"}
  </div>
  {/if}

  <div id="BoxBemerkungen">
    <strong>Bemerkungen:</strong><br>
    <div id="BemerkungenHistorie">{$AS.bemerkungen|nl2br}</div>
  </div>
  <br>
  <div id="BoxLieferhinweise">
    <strong>Lieferhinweise:</strong><br>
    <div id="LieferhinweiseContent">{$AS.lieferhinweise|nl2br}</div>
  </div>
  <div id="LoadingBar"></div>

  <style>
    #KundenabnahmeBox label {
      width:initial;
    }
    #KundenabnahmeBox label,
    #KundenabnahmeBox input {
      background-color: initial;
      border: initial;
      color: initial;
    }
    #KundenabnahmeBox label + input {
      margin-right:.5rem;
    }
    .m-signature-pad--body canvas {
      position: relative;
      left: 0;
      top: 0;
      width: 99%;
      height: 120px;
      border: 1px solid #CCCCCC;
      box-sizing: border-box;
      background-color: #eaf9ff;
    }

    #DialogBackLayer,
    .dialog-back-layer {
      position: fixed;
      top: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.75);
      z-index: 9999;
      box-sizing: border-box;
    }
    #DialogWrapper,
    .dialog-wrapper
    {
      border: 3px solid #0078dc;
      padding: 0.5rem;
      background-color: #ffffff;
      border-radius: .5rem;
      box-sizing: border-box;
    }
    .dialog-back-layer,
    .signature-dialog {
      display: none;
    }
    .signature-dialog-active {
      display: flex;
    }
    .doc-body-no-scrollbars {
      overflow: hidden !important;
    }
  </style>
  <div id="KundenabnahmeBox">
    <h2>Kundenabnahme</h2>
    <div>
      Die Ware wurde ordnungsgemäß geliefert und in einwandfreiem Zustand montiert. Ebenfalls bestätigen Sie hiermit, dass durch
      uns keine Schäden an Ihrem Gebäude und Ihren Räumlichkeiten entstanden sind. Sollten Schäden entstanden sein, notieren
      Sie diese bitte auf dem beiliegendem Reklamationsformular.
    </div>
    <div>
      <div style="display: inline-block;width:14rem;height:2rem;font-weight:bold;">
        <label style="width:initial;margin:initial;text-align: left;">Ihr Montageteam der merTens AG</label>
      </div>
      <div id="imgSignatureBoxMertens" style="display: inline-block;width:15rem;height:2rem;border-bottom:2px solid black;">
        <img id="imgSignatureMertens" src="" style="max-height:2rem;max-width:15rem;display:none;">
        <input id="lsSignatureMertens" type="hidden" name="signature_mertens" value="">
      </div>
    </div>

    <div>
      <label style="margin-right:3rem;width:initial;">Ankunft <input id="ankunftsZeit" type="time" size="8"> Uhr</label>
      <label style="margin-right:3rem;width:initial;">Abfahrt <input id="abfahrtsZeit" type="time" size="8"> Uhr</label>
    </div>
    <div>
      <label style="margin-right:3rem;width:initial;"><input id="etikettierungErfolgt" value="Ja" type="checkbox"> Eitekettierung erfolgt</label>
      <label style="margin-right:3rem;width:initial;"><input id="Schreibtisch" value="Ja" type="checkbox"> Schreibtisch</label>
      <label style="margin-right:3rem;width:initial;"><input id="Stuhl" value="Ja" type="checkbox"> Stuhl</label>
      <label style="margin-right:3rem;width:initial;"><input id="Lampe" value="Ja" type="checkbox"> Lampe</label>
    </div>

    <div>
      <div style="float:left;">
        <div style="border-bottom:2px solid black;height:2.5rem;display: inline-block;width:6rem;"></div>
        <div>(Datum)</div>
      </div>
      <div style="float:left;margin-left:2rem;">
        <div id="imgSignatureBoxMA" style="border-bottom:2px solid black;height:2.5rem;display: inline-block;width:15rem;">
          <img id="imgSignatureMA" src="" style="max-height:2rem;max-width:15rem;display:none;">
          <input id="lsSignatureMA" type="hidden" name="signature_ma" value="">
        </div>
        <div>(Name Kunde Blockbuchstaben / Unterschrift)</div>
      </div>
      <div style="clear: both"></div>
    </div>
  </div>

</div>

<script src="%WebRoot%js/signature_pad.js"></script>

  <div id="SigDialogMertens" class="signature-dialog dialog-back-layer">
    <div class="dialog-wrapper" style="width:90vw">
      <div id="signature-pad-mertens" style="display:none;width:90%;" date-refpad="" data-refimage="#imgSignatureMertens" data-refinput="#lsSignatureMertens" class="signature-pad m-signature-pad">
        <div style="font-weight:bold;">Montageteam der merTens AG</div>
        <div class="signature-pad--body m-signature-pad--body">
          <canvas id="canvas-sig-mertens" class="canvas-sig canvas-sig-mertens"></canvas>
        </div>
        <div style="text-align: center">
          <button type="button" onclick="cancelSignaturePad('#signature-pad-mertens');return false;" class="btn gray btn-cancel">Abbrechen</button>
          <button type="button" onclick="loeschenSignaturePad('#signature-pad-mertens');return false;" class="btn red btn-clear">Leeren</button>
          <button type="button" onclick="submitSignature('#signature-pad-mertens');return false;" class="btn green btn-apply">OK</button>
        </div>
      </div>

    </div>
  </div>

  <div id="SigDialogMA" class="signature-dialog dialog-back-layer">
    <div class="dialog-wrapper">
      <div id="signature-pad-ma" style="display:none;width:90vw;" data-refpad="" data-refimage="#imgSignatureMA" data-refinput="#lsSignatureMA" class="signature-pad m-signature-pad">
        <div style="font-weight:bold;">Name Kunde Blockbuchstaben / Unterschrift</div>
        <div class="signature-pad--body m-signature-pad--body">
          <canvas id="canvas-sig-ma" class="canvas-sig canvas-sig-ma"></canvas>
        </div>
        <div style="text-align: center">
          <button type="button" onclick="cancelSignaturePad('#signature-pad-ma');return false;" class="btn gray btn-cancel">Abbrechen</button>
          <button type="button" onclick="loeschenSignaturePad('#signature-pad-ma');return false;" class="btn red btn-clear">Leeren</button>
          <button type="button" onclick="submitSignature('#signature-pad-ma');return false;" class="btn green btn-apply">OK</button>
        </div>
      </div>

    </div>
  </div>

  <div id="statusCheck">Browser-Status-Check: <span id="browserOnlineStatus"></span></div>

  <div id="signature-pad-test" style="width:90vw;" data-refpad="" data-refimage="#imgSignatureMA" data-refinput="#lsSignatureMA" class="signature-pad m-signature-pad">
    <div class="signature-pad--body m-signature-pad--body">
      <canvas id="canvas-sig-test" class="canvas-sig canvas-sig-test"></canvas>
    </div>
  </div>
  <script>
    var aid = {$AS.aid|json_encode};
    {literal}

    $(function() {
      // SignaturePad.prototype.getPlainCanvasElement = function() {
      //   return this._canvas;
      // };
      //
      // SignaturePad.prototype.getCanvasElement = function() {
      //   return $(this._canvas);
      // };
      //
      // SignaturePad.prototype.getOuterBox = function() {
      //   return $(this._canvas).closest("div.signature-pad");
      // };
      //
      // SignaturePad.prototype.getOuterBody = function() {
      //   return $(this._canvas).closest("div.signature-pad-body");
      // };
      //
      // SignaturePad.prototype.getTargetInput = function() {
      //   var outerBox = this.getOuterBox();
      //   var refSelector = outerBox.data("refinput");
      //   if (refSelector) {
      //     return $(refSelector);
      //   }
      //   return null;
      // };
      //
      // SignaturePad.prototype.getTargetImage = function() {
      //   var outerBox = this.getOuterBox();
      //   var refSelector = outerBox.data("refimage");
      //   if (refSelector) {
      //     return $(refSelector);
      //   }
      //   return null;
      // };
      console.log('Initially ' + (window.navigator.onLine ? 'on' : 'off') + 'line');

      $(window).on('online', function() {
        console.log('Became online');
        $("#browserOnlineStatus").text("ONLINE");
      });
      $(window).on('offline', function() {
        console.log('Became offline');
        $("#browserOnlineStatus").text("OFFLINE");
      });

      document.getElementById('statusCheck').addEventListener('click', function() {
        var isOnline = window.navigator.onLine;
        console.log('window.navigator.onLine is ' + isOnline);
        $("#browserOnlineStatus").text(isOnline ? "ONLINE" : "OFFLINE");
      });

      var createSignaturPad = function(containerSelector, options) {
        var defaults = {
          minWidth: .5, // minimale Breite des Stiftes
          maxWidth: 3, // maximale Breite des Stiftes
          penColor: "#000000", // Stiftfarbe
          backgroundColor: '#FFFFFF'
        };
        var conf = defaults;
        if (options !== undefined && options !== null && typeof options === "object") {
          if ("minWidth" in options && !isNaN(options.minWidth) && options.minWidth > 0) {
            conf.minWidth = options.minWidth;
          }
          if ("maxWidth" in options && !isNaN(options.maxWidth) && options.maxWidth > 0) {
            conf.maxWidth = options.maxWidth;
          }
          if (conf.maxWidth < conf.minWidth) {
            conf.maxWidth = conf.minWidth;
          }
          if ("penColor" in options && typeof options.penColor === "string") {
            conf.penColor = options.penColor;
          }
          if ("backgroundColor" in options && typeof options.backgroundColor === "string") {
            conf.backgroundColor = options.backgroundColor;
          }
        }
        var container = $(containerSelector);
        if (container.length === 0) {
          console.error('Signatur-Pad Container not found by containerSelector', { containerSelector });
          return;
        }
        if (container.length > 1) {
          console.error('containerSelector selektiert mehr als ein Element', { containerSelector });
          return;
        }

        var jSigBody = container.find("[class$=body]");
        var jCanvas = container.find("canvas");

        if (jSigBody.length === 0) {
          jSigBody = $("<div/>").addClass("m-signature-pad--body").appendTo(container);
          if (jCanvas.length === 1) {
            jCanvas.appendTo(jSigBody);
          }
        }

        if (jCanvas.length === 0) {
          jCanvas = $("<canvas/>").appendTo(jSigBody);
        }

        var signaturePad = new SignaturePad(jCanvas.get(0), conf);
        container.data('refpad', signaturePad);

        $(window).on("resize", onResizeCanvas.bind(window, signaturePad));
        onResizeCanvas(signaturePad);

        console.log("createSignaturePad", { wrapper: container, jSigBody, jCanvas, signaturePad } );

        var targetImage = signaturePad.getTargetImage();
        if (targetImage && targetImage.length) {
          var targetImageParent = targetImage.parent();
          // targetImage.off("click").on("click", function() { showSignatureDialog(containerSelector); });
          targetImageParent.off("click").on("click", function() { showSignatureDialog(containerSelector); });
        }
        return signaturePad;
      };

      $(".signature-dialog").appendTo("body");
      createSignaturPad('#signature-pad-mertens');
      createSignaturPad('#signature-pad-ma');
      var canvasTest = document.getElementById('canvas-sig-test');
      var sigPadTest = new SignaturePad(canvasTest);
      onResizeCanvas(sigPadTest);

      // $("#imgSignatureBoxMertens").on("click", function() {
      //   showSignatureDialog('#signature-pad-mertens');
      // });
      // $("#imgSignatureBoxMA").on("click", function() {
      //   showSignatureDialog('#signature-pad-ma');
      // });

    });

    function onResizeCanvas(sigPad) {
      var oldContent = sigPad.toData();
      var sigPadCanvas = sigPad.getPlainCanvasElement();
      var ratio = Math.max(window.devicePixelRatio || 1, 1);
      sigPadCanvas.width = sigPadCanvas.offsetWidth * ratio;
      sigPadCanvas.height = sigPadCanvas.offsetHeight * ratio;
      sigPadCanvas.getContext("2d").scale(ratio, ratio);
      sigPad.clear();
      sigPad.fromData(oldContent);
    };

    function releaseContainerFromOverlay(container) {
      var originParent = container.data("originParent");
      var originPrev = container.data("originPrev");
      if (originPrev && originPrev.length && originParent && originParent.length) {
        if (originParent.get(0) === originPrev.parent().get(0)) {
          container.insertAfter(originPrev);
          return true;
        }
      }
      if (originParent && originParent.length === 1) {
        container.appendTo(originParent);
        return true;
      }
      if (originPrev && originPrev.length === 1) {
        container.insertAfter(originPrev);
        return true;
      }
      container.appendTo("body");
    }

    function showSignatureDialog(containerSelector) {

      var container = $(containerSelector);
      $("body").addClass("doc-body-no-scrollbars");
      $(".signature-dialog.signature-dialog-active").removeClass("signature-dialog-active");
      container.show().closest(".signature-dialog").addClass("signature-dialog-active");
      var signaturePad = container.data("refpad");
      console.log("showSignatureDialog: ", { containerData: container.data(), signaturePad })
      onResizeCanvas(signaturePad);
      return;
    }

    function createSignatureDialog(containerSelector) {

      var container = $(containerSelector);
      var overlayId = "DialogBackLayer";
      var overlay = $("#" + overlayId);
      var dialogWrapperId = "DialogWrapper";
      var dialogWrapper = $("#" + dialogWrapperId);

      var containerOriginPrev = container.data("originPrev");
      var containerOriginParent = container.data("originParent");

      if (!containerOriginParent) {
        container.data("originParent", container.parent());
      }

      if (!containerOriginPrev) {
        container.data("originPrev", container.prev());
      }

      if (overlay.length === 0) {
        overlay = $("<div/>")
                .attr({id: overlayId })
                .addClass(".dialog-back-layer")
                .appendTo("body");
      }

      if (dialogWrapper.length === 0) {
        dialogWrapper = $("<div/>")
                .attr({id: dialogWrapperId })
                .addClass(".dialog-wrapper")
                .appendTo(overlay);
      } else {
        dialogWrapper.find("*").each(function() {
          var originParent = $(this).data("originParent");
          var originPrev = $(this).data("originPrev");
          if (originParent.length > 0 || originPrev.length > 0) {
            releaseContainerFromOverlay( $(this) );
          }
        });
      }
      console.log('showSignatureDialog: ', { containerSelector, container, overlayId, overlay });
      overlay.show();
      dialogWrapper.show();

      container.appendTo(dialogWrapper)
              .css({
                width: "90vw"
              })
              .show();
    }

    function hideSignatureDialog(containerSelector) {

      var container = $(containerSelector);
      $("body").removeClass("doc-body-no-scrollbars");
      $(".signature-dialog.signature-dialog-active").removeClass("signature-dialog-active");
      container.hide().closest(".signature-dialog").removeClass("signature-dialog-active");
      return;

      var container = $(containerSelector);
      var overlayId = "DialogBackLayer";
      var overlay = $("#" + overlayId);
      console.log('hideSignatureDialog: ', { containerSelector, container, overlayId, overlay });
      container.hide();
      overlay.hide();
      releaseContainerFromOverlay( container );
    }

    function cancelSignaturePad(selector) {
      hideSignatureDialog(selector);
    }

    function submitSignature(selector) {
      var container = $(selector);
      var signaturePad = container.data("refpad");
      var img = signaturePad.getTargetImage();
      var input = signaturePad.getTargetInput();

      //Unterschrift in verstecktes Feld übernehmen
      var imgDataUrl = signaturePad.toDataURL();

      if (input && input.length) {
        input.val(imgDataUrl != "data:" ? imgDataUrl : '');
      } else {
        console.error('input not found', { selector, container, signaturePad, img, input });
      }

      if (img && img.length) {
        if (imgDataUrl.length > 6) {
          img.attr({src: imgDataUrl}).show();
        } else {
          img.attr({src: ''}).hide();
        }
      } else {
        console.error('img not found', { selector, container, signaturePad, img, input });
      }
      hideSignatureDialog(selector);
    }
    function loeschenSignaturePad(selector) {
      var container = $(selector);
      var signaturePad = container.data("refpad");
      var img = signaturePad.getTargetImage();
      var input = signaturePad.getTargetInput();

      signaturePad.clear();

      if (input && input.length) {
        input.val('');
      } else {
        console.error('input not found', { selector, container, signaturePad, img, input });
      }
      if (img && img.length) {
        img.hide().attr({src: ''});
      } else {
        console.error('img not found!', { selector, container, signaturePad, img, input });
      }
    }

    function getLieferscheinDaten(aid) {
      var storageKey = 'lieferschein_' + aid;
      var item = localStorage.getItem(storageKey);
      if (item === null) {
        return {};
      } else {
        return JSON.parse(item);
      }
    }
    function setLieferscheinDaten(aid, daten) {
      var storageKey = 'lieferschein_' + aid;
      daten.aid = aid;
      localStorage.setItem(storageKey, daten);
    }
    function addLieferscheinDaten(aid, name, value) {
      var daten = getLieferscheinDaten(aid);
      daten.aid = aid;
      daten[name] = value;
      localStorage.setItem(storageKey, daten);
    }
    function removeLieferscheinByAID(aid) {
      var storageKey = 'lieferschein_' + aid;
      localStorage.removeItem(storageKey);
    }
    function lieferscheinSpeichern() {


    }
    {/literal}
  </script>
  <form class="w3-container" action="process.php" method="POST"
        name="DAFORM" enctype="multipart/form-data" target="_self">
    <button type="button" onclick="return false;">Speichern</button>
  </form>

</div>
