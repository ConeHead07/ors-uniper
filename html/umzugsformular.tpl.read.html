<link rel="STYLESHEET" type="text/css" href="../css/SelBox.easy.css?%assetsRefreshId%">
<link rel="STYLESHEET" type="text/css" href="css/SelBox.easy.css?%assetsRefreshId%">

<div id="SysInfoBox"></div>

<link rel="stylesheet" type="text/css" href="css/umzugsformular.css?%assetsRefreshId%"/>
<link rel="stylesheet" type="text/css" href="../css/umzugsformular.css?%assetsRefreshId%"/>
<!-- MODUL UEBERSCHRIFTENBOX 109099 BEGIN --> 
<div class="divModuleBasic padding6px width5Col heightAuto colorContentMain"> 
<h1><span class="spanTitle">Auftrag</span></h1>

<div id="Umzugsantrag" class="divInlay" data-site="umzugsformular/tpl/read/html">
  <h2 style="margin:0;">Auftragsstatus</h2>
  <table>
    <tr>
      <td style="padding:0;width:200px;"><label style="display:block;width:auto;">Auftrags-ID:</label></td>
      <td style="padding:0;width:250px;"><div class="itxt itxt2col ireadonly">{$AS.aid|str_pad:8:"0":0}</div></td>
    </tr>
    <tr>
      <td style="padding:0;width:200px;"><label style="display:block;width:auto;">Auftragsdatum:</label></td>
      <td style="padding:0;width:250px;"><div class="itxt itxt2col ireadonly">{$AS.antragsdatum|escape|date_format:"%d.%m.%Y"}</div></td>
    </tr>
    <tr>
      <td style="padding:0;width:200px;"><label style="display:block;width:auto;">Auftragsstatus:</label></td>
      <td style="padding:0;width:250px;"><div class="itxt itxt2col ireadonly">{$AS.umzugsstatus}</div></td>
    </tr>
    <tr>
      <td style="padding:0;width:200px;" valign="top"><label style="display:block;width:auto;">Bisherige Bemerkungen:</label></td>
      <td style="padding:0;">{if empty($AS.bemerkungen)}<div class="itxt itxt2col ireadonly"><i>Keine</i></div>{/if}</td>
    </tr>
  </table>
  {if !empty($AS.bemerkungen)}
  <table width="100%">
    <tr>
      <td style="padding:0;">
        <div id="BemerkungenHistorie">{$AS.bemerkungen|nl2br}</div>
      </td>
    </tr>
  </table>
  {/if}

  <br>

  <h2 style="margin:0;">Lieferdaten</h2>
  <table>
  <tr>
    <td style="padding:0;width:200px;"><label style="background:#f00;border:0;display:block;width:auto;">Liefertermin:</label></td>
    <td style="padding:0;width:250px;"><div class="itxt itxt2col ireadonly">{if $AS.umzugsstatus ne "beantragt" and $AS.umzugsstatus ne "temp"}{$AS.umzugstermin|escape|date_format:"%d.%m.%Y"}{/if}</div></td>
  </tr>
  <tr>
    <td style="padding:0;"><label style="display:block;width:auto;">Vor &amp; Nachname:</label></td>
    <td style="padding:0;"><div class="itxt itxt2col ireadonly">{$AS.vorname|escape} {$AS.name|escape}</div></td>
  </tr>
  <tr>
    <td style="padding:0;"><label style="display:block;width:auto;">E-Mail:</label></td>
    <td style="padding:0;"><div class="itxt itxt2col ireadonly">{$AS.email|escape}</div></td>
  </tr>
  <tr>
    <td style="padding:0;"><label style="display:block;width:auto;">Telefon:</label></td>
    <td style="padding:0;"><div class="itxt itxt2col ireadonly">{$AS.fon|escape}</div></td>
  </tr>

  <tr>
    <td style="padding:0;"><label style="display:block;width:auto;">Stra&szlig;e &amp; Nr:</label></td>
    <td style="padding:0;"><div class="itxt itxt2col ireadonly">{$AS.strasse|escape}</div></td>
  </tr>

  <tr>
    <td style="padding:0;"><label style="display:block;width:auto;">PLZ:</label></td>
    <td style="padding:0;"><div class="itxt itxt2col ireadonly">{$AS.plz|escape}</div></td>
  </tr>

  <tr>
    <td style="padding:0;"><label style="display:block;width:auto;">Ort:</label></td>
    <td style="padding:0;"><div class="itxt itxt2col ireadonly">{$AS.ort|escape}</div></td>
  </tr>
{*
  <tr style="display:none;">
    <td style="padding:0;"><label style="display:block;width:auto;">Kostenstelle:</label></td>
    <td style="padding:0;"><div class="itxt itxt2col ireadonly">{$AS.kostenstelle|escape}</div></td>
  </tr>
*}
  <tr style="display:none;">
    <td style="padding:0;"><label style="display:block;width:auto;">Terminwunsch:</label></td>
    <td style="padding:0;"><div class="itxt itxt2col ireadonly">{$AS.terminwunsch|escape|date_format:"%d.%m.%Y"}</div></td>
  </tr>
  <tr style="display:none;">
    <td style="padding:0;"><label style="display:block;width:auto;">Uhrzeit</label></td>
    <td style="padding:0;"><div class="itxt itxt2col ireadonly">{$AS.umzugszeit|escape}</div></td>
  </tr>
</table>
  {if $AS.ansprechpartner}
<br>
<h2 style="margin:0;">Abweichender Ansprechpartner vor Ort</h2>
<table>
  <tr>
    <td style="padding:0;width:200px;"><label style="display:block;width:auto;">Vor &amp; Nachname</label></td>
    <td style="padding:0;width:300px;"><div class="itxt itxt2col ireadonly">{$AS.ansprechpartner|escape}</div></td>
  </tr>
  <tr>
    <td style="padding:0;"><label style="display:block;width:auto;">Fon</label></td>
    <td style="padding:0;"><div class="itxt itxt2col ireadonly">{$AS.ansprechpartner_fon|escape}</div></td>
  </tr>
</table>
  {/if}

{*
<table style="display:none">
  <tr>
    <td style="padding:0;width:200px;"><label style="display:block;width:auto;">Umzug</label></td>
    <td style="padding:0;width:300px;" class="options-onoff"><label class='{if $AS.service eq "Ja"}on{else}off{/if} active'>{$AS.service}</label></td>
  </tr>
</table>
*}
<br clear="both" >

{if 0}
    {include file="umzugsformular_mitarbeiterauswahl.tpl.read.html"}
{/if}
{if 0}
    {include file="umzugsformular_geraeteauswahl.tpl.read.html"}
{/if}
{if 1}
    {if $AS.autocalc_ref_mengen}
      {assign var="show_menge_mertens" value="0"}
    {else}
      {assign var="show_menge_mertens" value="1"}
    {/if}
    {include file="umzugsformular_leistungsauswahl.tpl.read.html" show_menge_mertens=$show_menge_mertens}
{/if}

{if !empty($UmzugsAnlagen)}
{include file="umzugsformular_attachments.tpl.read.html"}
{/if}

{if !empty($UmzugLieferscheine)}
<div style="margin-top:1.5rem"></div>
{include file="umzugsformular_lieferscheine.tpl.read2.html" UmzugsAnlagen=$UmzugLieferscheine internal=1}
{/if}

  {if !empty($Teillieferungen)}
  <div style="margin-top:1.5rem"></div>
  <fieldset><legend><strong>Teil-Lieferungen</strong></legend>
    <div style="padding:5px">
      {include file="admin_umzugsformular_teillieferungen.tpl.html" aItems=$Teillieferungen}
    </div>
  </fieldset>
  {/if}

  {if !empty($Reklamationen)}
  <div style="margin-top:1.5rem"></div>
  <fieldset><legend><strong>Reklamationen</strong></legend>
    <div style="padding:5px">
      {include file="admin_umzugsformular_reklamationen.tpl.html" aReklas=$Reklamationen}
    </div>
  </fieldset>
  {/if}

  <div style="margin-top:1.5rem"></div>
<form action="?s={$s}" method="post" name="frmUmzugsantrag">
<input type="hidden" name="AS[aid]" value="{$AS.aid}">
<input type="hidden" name="AS[token]" value="{$AS.token}">
<strong>Bemerkung hinzufügen:</strong><br>
<textarea class="iarea bemerkungen" name="AS[add_bemerkungen]"></textarea>
<br>


<input class='btn blue' type="submit" xstyle="padding:0 0 9px 0;background:url(images/BtnBlue_160.png) bottom left no-repeat;border:0;width:160px;height:24px;font-size:12px;color:#fff;font-weight:bold;" value="Bemerkung hinzufügen">

  {if true}<button id="btnShowReklaDialog" type="button" class="btn red">Leistung reklamieren</button>{/if}
</form>

<div id="LoadingBar"></div>

</div>
</div>


<div id="ReklaDialog" class="dialog dialog-back-layer">
  <div class="dialog-wrapper" style="width:90%">
    <div style="width:90%;">
      <form>
        <div id="reklaContent" style="max-height:80vh;overflow-y: auto;text-align:left;">

          {include file="admin_umzugsformular_leistungsauswahl.tpl.html"
          enableLeistungCheckbox="1"
          addReklas="1"
          showReklas="0"
          PreiseAnzeigen="0"
          mengeMertensReadOnly="1"
          mengeGeliefertReadOnly="1"
          title="Welche Leistung möchten Sie reklamieren"}

        </div>
        <div id="BoxBemerkungen" style="margin-top: 1rem">
          <strong>Reklamationsgrund hinzufügen: (<em>erforderlich</em>)</strong><br>
          <textarea class="iarea bemerkungen" name="grund" style="resize: vertical;overflow: auto"></textarea>
        </div>

        <div class="hint-box">
          <div class="hint-box-title">Wichtiger Hinweis, bitte lesen und beachten!</div>
          Beim Anlegen einer Reklamation wird zur Bearbeitung ein Reklamationsgrund benötigt.<br>
          Bitte prüfen Sie vor dem Absenden die ausgewählten Leistungen, Mengen und den Reklamationsgrund.
        </div>

        <div style="text-align: center;margin-top: 1rem">
          <input type="hidden" name="aid" value="{$AS.aid}">
          <button type="button" onclick="return false;" class="btn red btn-apply">Reklamation anlegen</button>
          <button type="button" onclick="return false;" class="btn gray btn-cancel">Schließen</button>
        </div>
      </form>
    </div>

  </div>
</div>

{literal}
<script>
  function showReklaDialog() {

    var container = $("#ReklaDialog");
    $("body").addClass("doc-body-no-scrollbars");
    var dialog = container.closest(".dialog");
    console.log({containerLength: container.length, dialogLength: dialog.length });
    dialog
            .addClass("dialog-active")
            .find("button.btn-cancel")
            .off("click")
            .on("click", function() {
              $("body").removeClass("doc-body-no-scrollbars");
              container.removeClass("dialog-active");
            }).end()
            .find("button.btn-apply")
            .off("click")
            .on("click", function() {
              alert("click");
              var btnApply = $(this);
              var frm = $(this).closest("form");
              var btnCancel = frm.find("button.btn-cancel");
              btnApply.prop("disabled", true);
              btnCancel.prop("disabled", true);

              var aid = frm.find('[name=aid]').val();
              var grund = frm.find('[name=grund]').val();
              var chckLeistungen = frm.find('[name=chckLeistung\\[\\]]:checked').serializeArray();
              console.log({ aid, chckLeistungen });

              var leistungen = [];
              for(var i = 0; i < chckLeistungen.length; i++) {
                var lid = chckLeistungen[i].value;
                var sel = '[name^=L\\[neue_rekla\\]\\[' + lid + '\\]]';
                console.log('Rekla-Mengen Selector: ', sel, frm.find(sel).length, frm.find(sel).val());
                var mng = frm.find('[name^=L\\[neue_rekla\\]\\[' + lid + '\\]]').val();
                if (!parseInt(mng)) {
                  alert("Für die " + (i+1) + ". ausgewählte Position wurde keine Menge angegeben!");
                  return;
                }
                leistungen.push({ leistung_id: lid, menge: mng });
              }
              console.log({ aid, chckLeistungen, leistungen });

              if(!leistungen.length) {
                alert("Es wurden keine Leistungen für die Reklamation ausgewählt!");
                return;
              }
              if ($.trim(grund) === "") {
                alert("Es wurden kein Grund für die Reklamation angegeben!");
                return;
              }
              if (false) {
                btnApply.prop("disabled", false);
                btnCancel.prop("disabled", false);
                return;
              }

              var request = $.post('/reklamieren.php',
                      {
                        aid,
                        leistungen,
                        grund
                      }, function(response) {
                        console.log({ response });
                        if (response.type === "success") {
                          alert("Reklamation wurde angelegt mit der ID " + response.reklaAid);
                        } else {
                          alert("Es sind Fehler aufgetreten!\n" + response.msg);
                        }
                      }
              );
              request.always(function() {
                $("body").removeClass("doc-body-no-scrollbars");
                btnApply.prop("disabled", false);
                btnCancel.prop("disabled", false);
              });
            }).end();
    return;
  }

  $(function() {
    $("#ReklaDialog").appendTo("body");
    var frm = $("#ReklaDialog").find("form");
    var tplTable = $("#ReklaDialog").find("#TplLeistungTable");
    frm.after(tplTable);

    frm.find("[name=chckLeistung\\[\\]]").on("change", function(e) {
      var lid = $(this).val();
      var row = $(this).closest(".row[data-row]").data("row");
      var neu = $(this).closest(".row").find("[name^=L\\[neue_rekla\\]]");
      if (!$(this).prop("checked")) {
        neu.val(0);
        return;
      }
      var mtMenge = parseFloat(row.menge_mertens || 1);
      var rkMenge = parseFloat(row.menge_rekla || 0);
      var glMenge = parseFloat(row.menge_geliefert || 0);
      var neuVal = Math.max(1, mtMenge - rkMenge - glMenge);

      neu.val(neuVal);
    });

    // $("#reklaContent").load("/textfiles/rekla.html");

    $("#btnShowReklaDialog").on("click", function(e) {
      e.preventDefault();
      showReklaDialog();
      return false;
    });
  });
</script>
{/literal}
