{literal}
<style type="text/css">
    th.order {
        cursor:pointer;
    }
    #Auswertung.divInlay input[type=data] {
        background-color: #e2f2ff;
    }
</style>
{/literal}
{if $s eq "auswertung"}
    {assign var="showStatus" value=1}
{else}
    {assign var="showStatus" value=0}
{/if}


<div style="display: flex;justify-content: space-between">
    <div>{include file="admin_auswertung_tabs.html" cat="auswertung" allusers=1 s="aantraege"}</div>
    <div style="align-self: flex-end;margin-right:5px;margin-bottom:2px;">
        <button id="btnCsvExport" class="btn btn-blue" style="padding:10px;cursor: pointer;">CSV-Export</button>
    </div>
</div>

<div class="divModuleBasic padding6px width5Col heightAuto colorContentMain">
    <h1><span class="spanTitle">Auswertung beauftragter Aufträge</span></h1>

    <div id="Auswertung" class="divInlay">
        <form id="frmStat" name="frmStat" method="get" action="?">
            <div id="frmFilterBox" style="margin-bottom:1rem; border:1px solid #E0E0E0;padding:1rem;border-radius:8px;">
                <span style="border:0;font-weight:bold;">Zeitraum
                    <select id="auswertungDatumsfeld" name="datumfeld">
                        <option value="umzugstermin">Lieferdatum</option>
                        <option value="antragsdatum">Auftragsdatum</option>
                        <!-- option value="geprueft_am">Bestätigungsdatum</option -->
                        <option value="berechnet_am">Rechnungsdatum</option>
                    </select>
                    Von: <input type="date" name="datumvon" style="border-bottom:1px solid #E0E0E0;text-align:right;padding-right:5px" value="{$datumvon}" xonchange="document.forms['frmStat'].submit()">
                    Bis: <input type="date" name="datumbis" style="border-bottom:1px solid #E0E0E0;text-align:right;padding-right:5px"  value="{$datumbis}" xonchange="document.forms['frmStat'].submit()">
                {*
                    <select onchange="document.forms['frmStat'].submit()" selected="{$kwvon}" name="kwvon" style="border:0;font-weight:bold;font-size:12px;width:150px;background:none;">
                <option value="">auswählen</option>
                        {html_options options=$kw_options selected=$kwvon}
                </select> bis
                <select onchange="document.forms['frmStat'].submit()" selected="{$kwbis}" name="kwbis" style="border:0;font-weight:bold;font-size:12px;width:150px;">
                <option value="">auswählen</option>
                        {html_options options=$kw_options selected=$kwbis}
                </select>
                    *}
                <input type="hidden" name="s" value="{$s}">
                <input type="hidden" name="order" value="" id="orderby">
                <input type="hidden" name="queriedorder" value="{$order}">
                <input type="hidden" name="queriedodir" value="{$odir}">


                    <div style="margin-top:5px;margin-bottom:5px;">
                        <label style="margin-right:2rem"><input type="checkbox" name="auftragsstatus[]" id="filter_beauftragt" value="beauftragt"> Beauftragt</label>
                        <label style="margin-right:2rem"><input type="checkbox" name="auftragsstatus[]" id="filter_avisiert" value="avisiert"> Avisiert</label>
                        <label style="margin-right:2rem"><input type="checkbox" name="auftragsstatus[]" id="filter_abgeschlossen" value="abgeschlossen"> Abgeschlossen</label>
                        <label style="margin-right:2rem"><input type="checkbox" name="auftragsstatus[]" id="filter_abgerechnet" value="abgerechnet"> Abgerechnet</label>
                    </div>
                        <button type="submit" class="btn btn-apply">Auswertung starten</button>
                </span>
            </div>

            <style type="text/css">{literal}
            th.order {
                cursor:pointer;
            }

            #TourStats .title {
                font-weight: bold;
                color: #0075b5;
                margin-top:1rem;
            }
            #TourStats .content,
            #TourStats .content-table {
                padding: 5px;
            }
            #TourStats .content-table {
                border-top: 1px solid #a4cbe0;
            }
            #TourStats .content {
                border: 1px solid #a4cbe0;
                border-radius: 5px;
                resize: vertical;
                height: 3rem;
                overflow: auto;
            }
            {/literal}</style>
            <script>
                var datumFilterFeld = "{$datumfeld}";
                var aAuftragsstatusFilter = {$aAuftragsstatus};
            </script>
            <script>{literal}
            $(function() {
                $("#auswertungDatumsfeld").val(datumFilterFeld);
                // $("#auswertungDatumsfeld").find("option[value=" + datumFilterFeld + "]").prop("selected", true);

                if (aAuftragsstatusFilter && Array.isArray(aAuftragsstatusFilter) && aAuftragsstatusFilter.length > 0) {
                    for(var ai = 0; ai < aAuftragsstatusFilter.length; ai++) {
                        var asel = '#filter_' + aAuftragsstatusFilter[ai];
                        $(asel).prop("checked", true);
                    }
                }

                var send = function() {
                    self.location.href = "?" + $("#frmStat").serialize();
                };

                $("th.order").click(function(e){
                    $("input#orderby").val( $(this).attr("data-fld") );
                    send();
                });

                $("th input").keypress(function(e){
                    if ( (e.keyCode || e.which) === 13) send();
                });

            });
            {/literal}
            </script>

            <div>
                <h2 style="float:left;" data-site="admin/antraege/liste/html">{$numAll} Aufträge</h2>
                <h2 style="float:right">{$sumAll|number_format:2:",":"."} &euro;</h2>
                <span style="clear: both"></span>
            </div>
            <span style="clear:both"></span>

            <div style="width:100%;overflow-x:scroll">
            <table id="tblTourenplanung" class="tblList">
                <thead>
                <tr>
                    <th class="order" data-fld="aid" title="Auftrags-ID">ID</th>
                    <th class="order" data-fld="kid">KID</th>
                    <th class="order" data-fld="land" title="Land">L.</th>
                    <th class="order" data-fld="ort" data-fld="ort">Lieferort</th>
                    <th class="order" data-fld="plz">PLZ</th>
                    <th class="order" data-fld="strasse">Stra&szlig;e</th>
                    <th class="order" data-fld="service">Service</th>
                    <th class="order" data-fld="antragsdatum" title="Auftragsdatum">Auftr.Dat.</th>
                    <th class="order" data-fld="umzugstermin" title="Liefertermin">Lief.Dat.</th>
                    <th class="order" data-fld="abgeschlossen_am" title="Abgeschlossen am">Abschluss</th>
                    <th class="order" data-fld="berechnet_am" title="Berechnet am">RechDatum</th>
                    <th class="order" data-fld="vorgangsnummer" title="Rechnungsnummer">RechNr</th>
                    {if $showStatus}
                    <th class="order" data-fld="umzugsstatus" title="Auftragsstatus">Stat</th>
                    {/if}
                    <th class="order" data-fld="Leistungen abgekürzt" title="Leistungen abgekürzt">Lstg.</th>
                    <th class="order" data-fld="summe" title="Summe">Summe</th>
                </tr>
                <tr>
                    <th><input name="q[aid]" style="width:100%" value="{if !empty($q) && isset($q.aid)}{$q.aid}{/if}"></th>
                    <th><input name="q[kid]" style="width:100%" value="{if !empty($q) && isset($q.kid)}{$q.kid}{/if}"></th>
                    <th><input name="q[land]" style="width:100%" value="{if !empty($q) && isset($q.land)}{$q.land}{/if}"></th>
                    <th><input name="q[ort]" style="width:100%" value="{if !empty($q) && isset($q.ort)}{$q.ort}{/if}"></th>
                    <th><input name="q[plz]" style="width:100%" value="{if !empty($q) && isset($q.plz)}{$q.plz}{/if}"></th>
                    <th><input name="q[strasse]" style="width:100%" value="{if !empty($q) && isset($q.strasse)}{$q.strasse}{/if}"></th>
                    <th><input name="q[service]" style="width:100%" value="{if !empty($q) && isset($q.service)}{$q.service}{/if}"></th>
                    <th><input placeholder="JJJJ-MM-TT" name="q[antragsdatum]" style="width:100%" value="{if !empty($q) && isset($q.antragsdatum)}{$q.antragsdatum}{/if}"></th>
                    <th><input placeholder="JJJJ-MM-TT" name="q[umzugstermin]" style="width:100%" value="{if !empty($q) && isset($q.umzugstermin)}{$q.umzugstermin}{/if}"></th>
                    <th><input placeholder="JJJJ-MM-TT" name="q[abgeschlossen_am]" style="width:100%" value="{if !empty($q) && isset($q.abgeschlossen_am)}{$q.abgeschlossen_am}{/if}"></th>
                    <th><input placeholder="JJJJ-MM-TT" name="q[berechnet_am]" style="width:100%" value="{if !empty($q) && isset($q.berechnet_am)}{$q.berechnet_am}{/if}"></th>
                    <th><input name="q[vorgangsnummer]" style="width:100%" value="{if !empty($q) && isset($q.vorgangsnummer)}{$q.vorgangsnummer}{/if}"></th>
                    {if $showStatus}
                    <th><input name="q[umzugsstatus]" style="width:100%" value="{if !empty($q) && isset($q.umzugsstatus)}{$q.umzugsstatus}{/if}"></th>
                    {/if}
                    <th><input name="q[Leistungen]" style="width:100%" value="{if !empty($q) && isset($q.Leistungen)}{$q.Leistungen}{/if}"></th>
                    <th><input name="q[summe]" style="width:100%" value="{if !empty($q) && isset($q.summe)}{$q.summe}{/if}"></th>
                </tr>
                </thead>
                <tbody>
                {foreach name=AList item=item from=$Auftraege}
                <tr class="flds-body-row data-href"
                        data-href="?s={$site_antrag}&id={$item.aid}"
                        data-umzugstermin="{$item.umzugstermin|escape}"
                        data-tour="{$item.tour_kennung|escape}"
                        data-aid="{$item.aid|escape}"
                        data-leistungen="{$item.Leistungen|escape}"
                        data-leistungenfull="{$item.LeistungenFull|escape}">
                    <td><a href="?s={$site_antrag}&id={$item.aid}">{$item.aid}</a></td>
                    <td>{$item.kid}</td>
                    <td>{if $item.land eq "Deutschland"}D{elseif $item.land eq "Niederlande"}NL{else}{$item.land|substr:0:3}{/if}</td>
                    <td>{$item.ort}</td>
                    <td>{$item.plz}</td>
                    <td>{$item.strasse}</td>
                    <td>{$item.service}</td>

                    <td title="{$item.antragsdatum|date_format:"%d.%m.%Y %H:%M"}">
                    {if !empty($item.antragsdatum) && {$item.antragsdatum|date_format:"%Y"} eq {'Y'|date}}
                    {$item.antragsdatum|date_format:"%d.%m."}
                    {else}
                    {$item.antragsdatum|date_format:"%d.%m.%y"}
                    {/if}
                    </td>

                    <td title="{$item.umzugstermin|date_format:"%d.%m.%Y"}">
                    {if !empty($item.umzugstermin) && {$item.umzugstermin|date_format:"%Y"} eq {'Y'|date}}
                    {$item.umzugstermin|date_format:"%d.%m."}
                    {else}
                    {$item.umzugstermin|date_format:"%d.%m.%y"}
                    {/if}
                    </td>

                    <td title="{$item.abgeschlossen_am|date_format:"%d.%m.%Y %H:%M"}">
                    {if !empty($item.abgeschlossen_am) && {$item.abgeschlossen_am|date_format:"%Y"} eq {'Y'|date}}
                    {$item.abgeschlossen_am|date_format:"%d.%m."}
                    {else}
                    {$item.abgeschlossen_am|date_format:"%d.%m.%y"}
                    {/if}
                    </td>


                    <td title="{$item.berechnet_am|date_format:"%d.%m.%Y %H:%M"}">
                    {if !empty($item.berechnet_am) && {$item.berechnet_am|date_format:"%Y"} eq {'Y'|date}}
                    {$item.berechnet_am|date_format:"%d.%m."}
                    {else}
                    {$item.berechnet_am|date_format:"%d.%m.%y"}
                    {/if}
                    </td>

                    <td>{$item.vorgangsnummer}</td>
                    {if $showStatus}
                    <td title="{$item.umzugsstatus|escape}">{$item.umzugsstatus|substr:0:5|escape}</td>
                    {/if}
                    <td title="{$item.LeistungenFull|replace:';':''|replace:'<|#|>':'  '}">{$item.Leistungen}</td>
                    <td style="text-align:right;">{$item.summe|number_format:2:",":"."} &euro;</td>
                </tr>
                {/foreach}
                </tbody>
            </table>
            </div>
        </form>

        <div id="TourStats">

        </div>
    </div>
</div>
<script>
{literal}

function numberFormat(number, dec) {
    var dec_point = ',';
    var thousands_sep = '.';
    if (isNaN(dec)) {
        dec = 2;
    }
    if (isNaN(+number)) {
        return number;
    }
    var parts = (+number).toFixed(dec).split(".");
    parts[0] = parts[0].split("").reverse();
    var fnum = [];
    for(var i = 0; i < parts[0].length; i++) {
        if ( i > 0 && i % 3 === 0 && !isNaN(parts[0][i]) ) {
            fnum.push(thousands_sep);
        }
        fnum.push( parts[0][i] );
    }

    return fnum.reverse().join("") + dec_point + parts[1];
}

var statsMetaByLid = {};
var statsOfAllItems = {};
var statsOfSelectedItems = {};
var selectorSelectedItems = "#tblTourenplanung input[type=checkbox][name^=aids\\[\\]]:checked";
var selectorAllItems = "#tblTourenplanung tr.flds-body-row";
var showCsvAids = false;
var showTotalLstgAbk = false;

function renderTourStats(stats) {
    var container = $("div#TourStats");
    container.html("");

    var aids = ("aids" in stats && Array.isArray(stats.aids)) ? stats.aids : [];

    if (showCsvAids) {
        var boxEnthalteneAids = $("<div/>")
            .append($("<div/>").addClass("title").text((aids.length ? aids.length + ' ' : '') + "Aufträge"))
            .append($("<div/>").addClass("content").text(aids.join(", ")))
            .appendTo(container);
    }

    var abks = ("LeistungenTotalAbk" in stats) ? stats.LeistungenTotalAbk : {};

    if (showTotalLstgAbk) {
        var boxAbks = $("<div/>").addClass("content");
        var boxEnthalteneAbks = $("<div/>")
            .append($("<div/>").addClass("title").text("Leistungen"))
            .append(boxAbks)
            .appendTo(container);

        for (var k in abks) {
            if (abks.hasOwnProperty(k)) {
                var n = abks[k];
                boxAbks.append($("<span/>").html(n.toString() + k + ' '));
            }
        }
    }

    var leistungen = ("LeistungenTotalLid" in stats && stats.LeistungenTotalLid) ? stats.LeistungenTotalLid : {};
    var tblLstg = $("<table/>").addClass("tblList").css("width", "100%");
    var boxEnthalteneAbks = $("<div/>")
        .append( $("<div/>").addClass("title").text( "Leistungsübersicht" ) )
        .append( $("<div/>").addClass("content-table").append( tblLstg ) )
        .appendTo(container);

    var thead = $("<thead/>").addClass("flds-head").appendTo(tblLstg);
    var tbody = $("<tbody/>").addClass("flds-head").appendTo(tblLstg);
    var thr = $("<tr/>").appendTo(thead);
    var thAbk = $("<th/>").addClass("fld-cell fld-abk").text('L-Abk').appendTo(thr);
    var thKtg = $("<th/>").addClass("fld-cell fld-ktg").text('Kategorie').appendTo(thr);
    var thBez = $("<th/>").addClass("fld-cell fld-bezeichnung").text('Bezeichnung').appendTo(thr);
    var thFarbe = $("<th/>").addClass("fld-cell fld-farbe").text('Farbe').appendTo(thr);
    var thGroese = $("<th/>").addClass("fld-cell fld-groesse").text('Größe').appendTo(thr);
    var thPreis = $("<th/>").addClass("fld-cell fld-preis menge float").text('Preis').appendTo(thr);
    var thMenge = $("<th/>").addClass("fld-cell fld-menge menge").text('Menge').appendTo(thr);
    var thSumme = $("<th/>").addClass("fld-cell fld-summe sum").text('Summe').appendTo(thr);


    var total = 0.0;
    for(var lg in leistungen) {
        if (leistungen.hasOwnProperty(lg)) {
            var menge = +leistungen[lg];
            var info = statsMetaByLid[lg];
            var preis = parseFloat(info.Preis);
            var summe = menge * preis;
            total+= summe;

            var tr = $("<tr/>").appendTo(tbody);

            tr
                .append( $("<td/>").text(info.Abk) )
                .append( $("<td/>").text(info.Kategorie) )
                .append( $("<td/>").text(info.Bezeichnung) )
                .append( $("<td/>").text(info.Farbe) )
                .append( $("<td/>").text(info.Groesse) )
                .append( $("<td/>").addClass("menge float currency-euro").text( numberFormat(preis) ) )
                .append( $("<td/>").addClass("menge int").text( menge) )
                .append( $("<td/>").addClass("menge sum float currency-euro").text( numberFormat(summe) ) )
            ;
        }
    }
    tbody.append(
        $("<tr/>").append(
            $("<td/>")
                .attr("colspan", 8)
                .addClass("menge sum float currency-euro")
                .text( numberFormat(total)
                )));
}

function procesTourStatsSelected() {
    var selector = selectorSelectedItems;
    return procesTourStatsBySelector(selector);
}

function procesTourStatsAll() {
    var selector = selectorAllItems;
    return procesTourStatsBySelector(selector);
}

function procesTourStatsBySelector(selector) {

    var stats = { aids: [], LeistungenTotalAbk: {}, LeistungenTotalKtg: {}, LeistungenTotalLid: {}, LeistungenByTermin: {}, LeistungenByTour: {} };
    var numItems = $(selector).closest("tr").length;
    console.log('#201 Found ', { numItems, selector });
    $(selector).closest("tr").each(function() {
        var d = $(this).data();
        // console.log('#235 Tourenplanung', { d  });
        // return;
        if (!$.trim(d.leistungenfull)) {
            console.log('#236 empty leistungenfull for aid ' + d.aid, d);
            return;
        }
        if (!$.trim($.trim(d.leistungenfull).split(";\n").join("").split("<|#|>").join("") )) {
            return;
        }
        var aLstFull = d.leistungenfull.split(";\n");
        var tour = d.tour;
        var liefertermin = d.umzugstermin;

        var lstg = [];
        for(li = 0; li < aLstFull.length; li++) {
            var csv = aLstFull[li].split("<|#|>");
            var lid = csv[0];
            var Abk = csv[1];
            if (!Abk) {
                console.error('#253 empty abk', { d, aLstFull, tour, liefertermin, lid });
            }
            var Kategorie = csv[2];
            var Bezeichnung = csv[3];
            var Farbe = csv[4];
            var Groesse = csv[5];
            var Waehrung = csv[6];
            var Preis = csv[7];
            var lstObj = { lid, Abk, Kategorie, Bezeichnung, Farbe, Groesse, Waehrung, Preis, csv };
            if (!(lid in statsMetaByLid)) {
                statsMetaByLid[lid] = lstObj;
            }
            lstg.push({ lid, Abk, Kategorie, Bezeichnung, Farbe, Groesse, Waehrung, Preis, csv });
        }
        console.log('#235 Tourenplanung', { d, 'aLstFull.length': aLstFull.length, 'lstg.length': lstg.length, aLstFull, tour, liefertermin });

        stats.aids.push(d.aid);
        for(var li = 0; li < lstg.length; li++) {
            var abk = lstg[li].Abk;
            if (!(abk in stats.LeistungenTotalAbk)) {
                stats.LeistungenTotalAbk[abk] = 1;
            } else {
                ++stats.LeistungenTotalAbk[abk];
            }


            var ktg = lstg[li].Kategorie;
            if (!(ktg in stats.LeistungenTotalKtg)) {
                stats.LeistungenTotalKtg[ktg] = 1;
            } else {
                ++stats.LeistungenTotalKtg[ktg];
            }

            var lid = lstg[li].lid;
            if (!(lid in stats.LeistungenTotalLid)) {
                stats.LeistungenTotalLid[lid] = 1;
            } else {
                ++stats.LeistungenTotalLid[lid];
            }

            if (tour) {
                if (!(tour in stats.LeistungenByTour)) {
                    stats.LeistungenByTour[tour] = {
                        Abk: {}, Ktg: {}, Lid: {}
                    };
                }
                if (!(abk in stats.LeistungenByTour[tour].Abk)) {
                    stats.LeistungenByTour[tour].Abk[abk] = 1;
                } else {
                    ++stats.LeistungenByTour[tour].Abk[abk];
                }
                if (!(ktg in stats.LeistungenByTour[tour].Ktg)) {
                    stats.LeistungenByTour[tour].Ktg[ktg] = 1;
                } else {
                    ++stats.LeistungenByTour[tour].Ktg[ktg];
                }
                if (!(lid in stats.LeistungenByTour[tour].Lid)) {
                    stats.LeistungenByTour[tour].Lid[lid] = 1;
                } else {
                    ++stats.LeistungenByTour[tour].Lid[lid];
                }
            }
            if (liefertermin) {
                if (!(liefertermin in stats.LeistungenByTermin)) {
                    stats.LeistungenByTermin[liefertermin] = {
                        Liefertermin: liefertermin, Abk: {}, Ktg: {}, Lid: {}
                    };
                }
                if (!(abk in stats.LeistungenByTermin[liefertermin].Abk)) {
                    stats.LeistungenByTermin[liefertermin].Abk[abk] = 1;
                } else {
                    ++stats.LeistungenByTermin[liefertermin].Abk[abk];
                }
                if (!(ktg in stats.LeistungenByTermin[liefertermin].Ktg)) {
                    stats.LeistungenByTermin[liefertermin].Ktg[ktg] = 1;
                } else {
                    ++stats.LeistungenByTermin[liefertermin].Ktg[ktg];
                }
                if (!(lid in stats.LeistungenByTermin[liefertermin].Lid)) {
                    stats.LeistungenByTermin[liefertermin].Lid[lid] = 1;
                } else {
                    ++stats.LeistungenByTermin[liefertermin].Lid[lid];
                }
            }
        }
    });
    console.log("335 stats", { stats, statsMetaByLid });
    return stats;
}


$(function() {

    $(".geo-address[data-address]").each(function () {
        var gmapUrl = "https://www.google.com/maps/dir/?api=1&travelmode=driving&destination=";
        var query = encodeURIComponent($(this).data("address"));
        // https://www.google.com/maps/dir/?api=1&destination=Mainzer+Straße+97,65189+Wiesbaden,Deutschland&travelmode=driving
        $(this)
            .wrap(
                $("<a/>").attr({
                    href: gmapUrl + query,
                    target: "gmap",
                    title: "Lieferadresse in Gmap anzeigen"
                }))
            .prepend($("<i/>").addClass("marker icon").css("width", "auto"))
            .addClass("marker icon")
            .bind("click", function (e) {
                e.stopPropagation();
            });
    });

    statsOfAllItems = procesTourStatsAll();
    renderTourStats(statsOfAllItems);



    var send = function(addQuery = '') {
        var url = "?" + $("#frmStat :input")
            .filter(function(index, element) {
                if (['radio', 'checkbox'].indexOf(element.type) !== -1) {
                    return element.checked;
                }
                return $.trim($(element).val()) !== '';
            })
            .serialize();

        if (addQuery && addQuery.charAt(0) !== '&') {
            addQuery = '&' + addQuery;
        }
        // alert('url: ' + url + "\naddQuery: " + addQuery);
        self.location.href = url + addQuery;
    };

    $("#btnCsvExport").bind("click", function() {
        send('format=csv');
    });
});
{/literal}
</script>
