<pre style="display: none;">
html/auswertung_form.html
Rechnungsstellung nur Mertens-Henk:
 
Es wird eine Funktion zur Abrechnung der Vorgänge benötigt.
Hierzu soll eine Auswahl von KW bis KW  und das Jahr angegeben werden.
Daraus soll eine Liste mit allen Vorgängen die Abgeschlossen worden sind
und noch nicht abgerechnet worden sind mit
Folgenden Feldern ausgegeben werden:
 
ID|STOM|Region|Standort|Wirtschaftseinheit|PSP-Element|Planon Nr.|Leistungsdatum|AbschlussDatum|Summe
 
Unter dieser Tabelle muss es ein Feld geben wo wir unsere WWS Vorgangs Nr. 
eintragen können und dann ein Fertigsstellungsbutton.
Beim Bestätigen müssen der Status alle angezeigten Vorgänge auf Berechnet
gesetzt werden und das Rechnungsdatum des aktuellen Tages eingetragen werden.
</pre>
<div class="divModuleBasic padding6px width5Col heightAuto colorContentMain">
    <h1><span class="spanTitle">Abrechnung abgeschlossener Aufträge</span></h1>

    <div id="Auswertung" class="divInlay">
<form id="frmStat" name="frmStat" method="get" action="?" data-site="auswertung/form/html">
    <span style="border:0;font-weight:bold;font-size:12px;">
    Zeitraum
    <select id="auswertungDatumsfeld" name="datumfeld">
        <option value="umzugstermin">Lieferdatum</option>
        <option value="antragsdatum">Auftragsdatum</option>
        <option value="abgeschlossen_am">Abschlussdatum</option>
        <!-- option value="bestaetigt_am">Bestätigungsdatum</option -->
        <option value="berechnet_am">Rechnungsdatum</option>
    </select>
    Von: <input type="date" name="datumvon" value="{$datumvon}" xonchange="document.forms['frmStat'].submit()">
    Bis: <input type="date" name="datumbis" value="{$datumbis}" xonchange="document.forms['frmStat'].submit()">
    {*
Kalenderwoche
<select onchange="document.forms['frmStat'].submit()" selected="{$kwvon}" name="kwvon" style="border:0;font-weight:bold;font-size:12px;width:150px;background:none;">
<option value="">auswählen</option>
        {html_options options=$kw_options selected=$kwvon}
</select> bis 
<select onchange="document.forms['frmStat'].submit()" selected="{$kwbis}" name="kwbis" style="border:0;font-weight:bold;font-size:12px;width:150px;background:none;">
<option value="">auswählen</option>
        {html_options options=$kw_options selected=$kwbis}
</select>
    *}
<input style="margin-left:15px;" id="all" name="all" type="checkbox" value="1" {if $all}checked="checked"{/if}><label for="all"><span title="Auch bereits abgerechnete Leistungen anzeigen">Alle</span></label>
<input type="hidden" name="s" value="{$s}">
<input type="hidden" name="order" value="" id="orderby">
<input type="hidden" name="queriedorder" value="{$order}">
<input type="hidden" name="queriedodir" value="{$odir}">
<button type="submit" class="btn btn-apply">Auswertung starten</button>
<noscript>&lt;input type="submit" value="Auswertung starten"&gt;</noscript>
</span>
<style type="text/css">{literal}
    th.order {
        cursor:pointer;
    }
{/literal}</style>
<script>
    var datumFilterFeld = "{$datumfeld}";
</script>
<script>{literal}

$(function(){

    $("#auswertungDatumsfeld").val(datumFilterFeld);
    
    var send = function() {
        self.location.href = "?" + $("#frmStat").serialize();
    };
    
    $("th.order").click(function(e){        
        $("input#orderby").val( $(this).attr("data-fld") );
        send();
    });
    
    $("th input").keypress(function(e){
        if ( (e.keyCode || e.which) === 13) send();
    });
    
});
{/literal}
</script>

<table class="tblList">
    <thead>
        <tr>
            <th style="cursor:pointer" {literal}
                onclick="(function(){
                    $('input:checkbox[name^=aids]').attr('checked', !$('input:checkbox[name^=aids]:first').is(':checked') );
            })(){/literal}">x</th>
            <th class="order" data-fld="aid">ID</th>
            <th class="order" data-fld="kid">KID</th>
            <th class="order" data-fld="land">Land</th>
            <th class="order" data-fld="ort">Lieferort</th>
            <th class="order" data-fld="PLZ">PLZ</th>
            <th class="order" data-fld="strasse">Stra&szlig;e</th>
            <th class="order" data-fld="service">Service</th>
            <th class="order" data-fld="antragsdatum">Auftr.Dat.</th>
            <th class="order" data-fld="umzugstermin">Geliefert</th>
            <th class="order" data-fld="abgeschlossen_am">Abschluss</th>
            <th class="order" data-fld="summe">Summe</th>
        </tr>
        <tr>
            <th></th>
            <th><input name="q[aid]" style="width:100%" value="{if !empty($q) && isset($q.aid)}{$q.aid}{/if}"></th>
            <th><input name="q[kid]" style="width:100%" value="{if !empty($q) && isset($q.kid)}{$q.kid}{/if}"></th>
            <th><input name="q[land]" style="width:100%" value="{if !empty($q) && isset($q.land)}{$q.land}{/if}"></th>
            <th><input name="q[ort]" style="width:100%" value="{if !empty($q) && isset($q.ort)}{$q.ort}{/if}"></th>
            <th><input name="q[plz]" style="width:100%" value="{if !empty($q) && isset($q.plz)}{$q.plz}{/if}"></th>
            <th><input name="q[strasse]" style="width:100%" value="{if !empty($q) && isset($q.strasse)}{$q.strasse}{/if}"></th>
            <th><input name="q[service]" style="width:100%" value="{if !empty($q) && isset($q.service)}{$q.service}{/if}"></th>
            <th><input name="q[antragsdatum]" placeholder="JJJJ-MM-TT" style="width:100%" value="{if !empty($q) && isset($q.antragsdatum)}{$q.antragsdatum}{/if}"></th>
            <th><input name="q[umzugstermin]" placeholder="JJJJ-MM-TT" style="width:100%" value="{if !empty($q) && isset($q.umzugstermin)}{$q.umzugstermin}{/if}"></th>
            <th><input name="q[abgeschlossen_am]" placeholder="JJJJ-MM-TT" style="width:100%" value="{if !empty($q) && isset($q.abgeschlossen_am)}{$q.abgeschlossen_am}{/if}"></th>
            <th><input name="q[summe]" style="width:100%" value="{if !empty($q) && isset($q.summe)}{$q.summe}{/if}"></th>
        </tr>
    </thead>
    </thead>
    <tbody>
    {foreach name=AList item=item from=$Auftraege}
        <tr>
            {if !empty($aAids) and in_array($item.aid, $aAids)}
            {assign var="checked" value="checked=\"checked\""}
            {else}
            {assign var="checked" value=""}
            {/if}
            <td>{if !$item.berechnet_am}<input type="checkbox" name="aids[]" {$checked} value="{$item.aid}">{/if}</td>
            <td><a href="?s={$site_antrag}&id={$item.aid}">{$item.aid}</a></td>
            <td>{$item.kid}</td>
            <td>{if $item.land eq "Deutschland"}DE{elseif $item.land eq "Niederlande"}NL{else}{$item.land}{/if}</td>
            <td>{$item.ort}</td>
            <td>{$item.plz}</td>
            <td>{$item.strasse}</td>
            <td>{$item.service}</td>
            <td title="{$item.antragsdatum|date_format:"%d.%m.%Y %H:%M"}">
                {if !empty($item.antragsdatum) && {$item.antragsdatum|date_format:"%Y"} eq {'Y'|date}}
                    {$item.antragsdatum|date_format:"%d.%m."}
                {else}
                    {$item.antragsdatum|date_format:"%d.%m.%y"}
                {/if}
            </td>

            <td title="{$item.umzugstermin|date_format:"%d.%m.%Y"}">
            {if !empty($item.umzugstermin) && {$item.umzugstermin|date_format:"%Y"} eq {'Y'|date}}
                {$item.umzugstermin|date_format:"%d.%m."}
            {else}
                {$item.umzugstermin|date_format:"%d.%m.%y"}
            {/if}
            </td>

            <td title="{$item.abgeschlossen_am|date_format:"%d.%m.%Y %H:%M"}">
            {if !empty($item.abgeschlossen_am) && {$item.abgeschlossen_am|date_format:"%Y"} eq {'Y'|date}}
            {$item.abgeschlossen_am|date_format:"%d.%m."}
            {else}
            {$item.abgeschlossen_am|date_format:"%d.%m.%y"}
            {/if}
            </td>

            <td style="text-align:right;">{$item.summe|number_format:2:",":"."} &euro;</td>
        </tr>
        {/foreach}

    {if !empty($TeilLieferungen) && count($TeilLieferungen) > 0}
    <tr>
        <th colspan="12">Teil-Lieferungen (Ohne Spaltenfilter)</th>
    </tr>
    {foreach name=AList item=item from=$TeilLieferungen}
    <tr>
        {if !empty($aUlids) and in_array($item.ulid, $aUlids)}
            {assign var="checked" value="checked=\"checked\""}
        {else}
            {assign var="checked" value=""}
        {/if}
        <td>{if !$item.berechnet_am}<input type="checkbox" name="ulids[]" {$checked} value="{$item.ulid}">{/if}</td>
        <td><a href="?s={$site_antrag}&id={$item.aid}">TL-{$item.ulid}</a></td>
        <td>{$item.kid}</td>
        <td>{if $item.land eq "Deutschland"}DE{elseif $item.land eq "Niederlande"}NL{else}{$item.land}{/if}</td>
        <td>{$item.ort}</td>
        <td>{$item.plz}</td>
        <td>{$item.strasse}</td>
        <td>{$item.service}</td>
        <td title="{$item.antragsdatum|date_format:"%d.%m.%Y %H:%M"}">
        {if !empty($item.antragsdatum) && {$item.antragsdatum|date_format:"%Y"} eq {'Y'|date}}
        {$item.antragsdatum|date_format:"%d.%m."}
        {else}
        {$item.antragsdatum|date_format:"%d.%m.%y"}
        {/if}
        </td>

        <td title="{$item.lieferdatum|date_format:"%d.%m.%Y"}">
        {if !empty($item.lieferdatum) && {$item.lieferdatum|date_format:"%Y"} eq {'Y'|date}}
        {$item.lieferdatum|date_format:"%d.%m."}
        {else}
        {$item.lieferdatum|date_format:"%d.%m.%y"}
        {/if}
        </td>

        <td title="">
        </td>

        <td style="text-align:right;">{$item.summe|number_format:2:",":"."} &euro;</td>
    </tr>
    {/foreach}
    {/if}
    </tbody>
</table>
    {if !empty($q) && !empty($q.aids)}
    <div style="margin-top:.5rem">
        <label style="font-weight: bold;">Auftrag-Ids</label>
        <textarea placeholder="Auftrags-Ids" name="q[aids]" id="q_aids" style="width:100%;resize:vertical;overflow:auto;border:1px solid #888888; border-radius:5px;padding:5px;box-sizing: border-box;">{if !empty($q.aids)}{$q.aids|escape}{/if}</textarea>
    </div>
    {/if}

    {if !empty($q) && !empty($q.ulids)}
    <div style="margin-top:.5rem">
        <label style="font-weight: bold;">Teil-Lieferungs-Ids</label>
        <textarea placeholder="Teil-Lieferungs-Ids" name="q[ulids]" style="width:100%;resize:vertical;overflow:auto;border:1px solid #888888; border-radius:5px;padding:5px;box-sizing: border-box;">{if !empty($q.ulids)}{$q.ulids|escape}{/if}</textarea>
    </div>
    {/if}
    <div style="margin-top:.5rem">
        <label style="font-weight: bold;">Rechnungsnr zuweisen</label><br>
    <input type="text" name="wwsnr" placeholder="Vorgangsnummer" size="15" style="border:1px solid #888888;width:180px;font-size:11px;border-radius:5px;padding:5px;" value="{$wwsnr}">
    </div>
    <input type="submit" name="finish" value="Rechnungsnummer jetzt zuweisen"
       style="margin-top:0.5rem;cursor:pointer;border:1px solid #41b3f3;background-color:#41b3f3;color:#fff;font-weight:bold;border-radius:5px;padding:5px;">
</form>
    </div>
</div>
